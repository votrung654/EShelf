name: Smart Build Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'README.md'
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'presentation.tex'
      - 'CHECKLIST_YEU_CAU.md'
      - 'DEMO_GUIDE.md'
      - 'yeucaumonhoc.md'
      - 'gopygiangvien.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'presentation.tex'
      - 'CHECKLIST_YEU_CAU.md'
      - 'DEMO_GUIDE.md'
      - 'yeucaumonhoc.md'
      - 'gopygiangvien.md'

jobs:
  # Detect changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.code-check.outputs.frontend }}
      api-gateway: ${{ steps.code-check.outputs.api-gateway }}
      auth-service: ${{ steps.code-check.outputs.auth-service }}
      book-service: ${{ steps.code-check.outputs.book-service }}
      user-service: ${{ steps.code-check.outputs.user-service }}
      ml-service: ${{ steps.code-check.outputs.ml-service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Cần 2 commits để so sánh
      
      # Bước 1: Filter paths (nhanh hơn)
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'public/**'
              - 'index.html'
              - 'package.json'
              - 'vite.config.js'
            api-gateway:
              - 'backend/services/api-gateway/**'
            auth-service:
              - 'backend/services/auth-service/**'
            book-service:
              - 'backend/services/book-service/**'
            user-service:
              - 'backend/services/user-service/**'
            ml-service:
              - 'backend/services/ml-service/**'
      
      # Bước 2: Check xem có code changes thực sự không (bỏ qua comment)
      - name: Check for real code changes
        id: code-check
        run: |
          chmod +x scripts/check-service-changes.sh
          
          # Base ref để so sánh
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="HEAD~1"
          fi
          
          # Check frontend
          if [ "${{ steps.filter.outputs.frontend }}" = "true" ]; then
            if ./scripts/check-service-changes.sh src public index.html package.json vite.config.js "$BASE_REF"; then
              echo "frontend=true" >> $GITHUB_OUTPUT
              echo "✓ frontend: Real code changes detected"
            else
              echo "frontend=false" >> $GITHUB_OUTPUT
              echo "✗ frontend: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "○ frontend: No file changes"
          fi
          
          # Check api-gateway
          if [ "${{ steps.filter.outputs.api-gateway }}" = "true" ]; then
            if ./scripts/check-service-changes.sh backend/services/api-gateway "$BASE_REF"; then
              echo "api-gateway=true" >> $GITHUB_OUTPUT
              echo "✓ api-gateway: Real code changes detected"
            else
              echo "api-gateway=false" >> $GITHUB_OUTPUT
              echo "✗ api-gateway: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "api-gateway=false" >> $GITHUB_OUTPUT
            echo "○ api-gateway: No file changes"
          fi
          
          # Check auth-service
          if [ "${{ steps.filter.outputs.auth-service }}" = "true" ]; then
            if ./scripts/check-service-changes.sh backend/services/auth-service "$BASE_REF"; then
              echo "auth-service=true" >> $GITHUB_OUTPUT
              echo "✓ auth-service: Real code changes detected"
            else
              echo "auth-service=false" >> $GITHUB_OUTPUT
              echo "✗ auth-service: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "auth-service=false" >> $GITHUB_OUTPUT
            echo "○ auth-service: No file changes"
          fi
          
          # Check book-service
          if [ "${{ steps.filter.outputs.book-service }}" = "true" ]; then
            if ./scripts/check-service-changes.sh backend/services/book-service "$BASE_REF"; then
              echo "book-service=true" >> $GITHUB_OUTPUT
              echo "✓ book-service: Real code changes detected"
            else
              echo "book-service=false" >> $GITHUB_OUTPUT
              echo "✗ book-service: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "book-service=false" >> $GITHUB_OUTPUT
            echo "○ book-service: No file changes"
          fi
          
          # Check user-service
          if [ "${{ steps.filter.outputs.user-service }}" = "true" ]; then
            if ./scripts/check-service-changes.sh backend/services/user-service "$BASE_REF"; then
              echo "user-service=true" >> $GITHUB_OUTPUT
              echo "✓ user-service: Real code changes detected"
            else
              echo "user-service=false" >> $GITHUB_OUTPUT
              echo "✗ user-service: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "user-service=false" >> $GITHUB_OUTPUT
            echo "○ user-service: No file changes"
          fi
          
          # Check ml-service
          if [ "${{ steps.filter.outputs.ml-service }}" = "true" ]; then
            if ./scripts/check-service-changes.sh backend/services/ml-service "$BASE_REF"; then
              echo "ml-service=true" >> $GITHUB_OUTPUT
              echo "✓ ml-service: Real code changes detected"
            else
              echo "ml-service=false" >> $GITHUB_OUTPUT
              echo "✗ ml-service: Only comment/whitespace changes, skipping build"
            fi
          else
            echo "ml-service=false" >> $GITHUB_OUTPUT
            echo "○ ml-service: No file changes"
          fi

  # Build Frontend (only if changed)
  build-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        continue-on-error: false
      
      - name: Upload artifacts
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/

  # Build API Gateway (only if changed)
  build-api-gateway:
    needs: changes
    if: needs.changes.outputs.api-gateway == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          if [ -n "${{ secrets.HARBOR_REGISTRY }}" ] && [ -n "${{ secrets.HARBOR_USERNAME }}" ] && [ -n "${{ secrets.HARBOR_PASSWORD }}" ]; then
            REGISTRY="${{ secrets.HARBOR_REGISTRY }}"
            PUSH_IMAGE=true
          else
            REGISTRY="eshelf"
            PUSH_IMAGE=false
            echo "Harbor credentials not configured, building only (no push)"
          fi
          docker build -t $REGISTRY/api-gateway:$IMAGE_TAG backend/services/api-gateway/
          docker tag $REGISTRY/api-gateway:$IMAGE_TAG $REGISTRY/api-gateway:latest
          if [ "$PUSH_IMAGE" = "true" ]; then
            docker push $REGISTRY/api-gateway:$IMAGE_TAG
            docker push $REGISTRY/api-gateway:latest
          else
            echo "Skipping push - Harbor credentials not configured"
          fi

  # Build Auth Service (only if changed)
  build-auth-service:
    needs: changes
    if: needs.changes.outputs.auth-service == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          if [ -n "${{ secrets.HARBOR_REGISTRY }}" ] && [ -n "${{ secrets.HARBOR_USERNAME }}" ] && [ -n "${{ secrets.HARBOR_PASSWORD }}" ]; then
            REGISTRY="${{ secrets.HARBOR_REGISTRY }}"
            PUSH_IMAGE=true
          else
            REGISTRY="eshelf"
            PUSH_IMAGE=false
            echo "Harbor credentials not configured, building only (no push)"
          fi
          docker build -t $REGISTRY/auth-service:$IMAGE_TAG backend/services/auth-service/
          docker tag $REGISTRY/auth-service:$IMAGE_TAG $REGISTRY/auth-service:latest
          if [ "$PUSH_IMAGE" = "true" ]; then
            docker push $REGISTRY/auth-service:$IMAGE_TAG
            docker push $REGISTRY/auth-service:latest
          else
            echo "Skipping push - Harbor credentials not configured"
          fi

  # Build Book Service (only if changed)
  build-book-service:
    needs: changes
    if: needs.changes.outputs.book-service == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          if [ -n "${{ secrets.HARBOR_REGISTRY }}" ] && [ -n "${{ secrets.HARBOR_USERNAME }}" ] && [ -n "${{ secrets.HARBOR_PASSWORD }}" ]; then
            REGISTRY="${{ secrets.HARBOR_REGISTRY }}"
            PUSH_IMAGE=true
          else
            REGISTRY="eshelf"
            PUSH_IMAGE=false
            echo "Harbor credentials not configured, building only (no push)"
          fi
          docker build -t $REGISTRY/book-service:$IMAGE_TAG backend/services/book-service/
          docker tag $REGISTRY/book-service:$IMAGE_TAG $REGISTRY/book-service:latest
          if [ "$PUSH_IMAGE" = "true" ]; then
            docker push $REGISTRY/book-service:$IMAGE_TAG
            docker push $REGISTRY/book-service:latest
          else
            echo "Skipping push - Harbor credentials not configured"
          fi

  # Build User Service (only if changed)
  build-user-service:
    needs: changes
    if: needs.changes.outputs.user-service == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          if [ -n "${{ secrets.HARBOR_REGISTRY }}" ] && [ -n "${{ secrets.HARBOR_USERNAME }}" ] && [ -n "${{ secrets.HARBOR_PASSWORD }}" ]; then
            REGISTRY="${{ secrets.HARBOR_REGISTRY }}"
            PUSH_IMAGE=true
          else
            REGISTRY="eshelf"
            PUSH_IMAGE=false
            echo "Harbor credentials not configured, building only (no push)"
          fi
          docker build -f backend/services/user-service/Dockerfile -t $REGISTRY/user-service:$IMAGE_TAG backend/
          docker tag $REGISTRY/user-service:$IMAGE_TAG $REGISTRY/user-service:latest
          if [ "$PUSH_IMAGE" = "true" ]; then
            docker push $REGISTRY/user-service:$IMAGE_TAG
            docker push $REGISTRY/user-service:latest
          else
            echo "Skipping push - Harbor credentials not configured"
          fi
        continue-on-error: false

  # Build ML Service (only if changed)
  build-ml-service:
    needs: changes
    if: needs.changes.outputs.ml-service == 'true' && github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Harbor
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.HARBOR_REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          if [ -n "${{ secrets.HARBOR_REGISTRY }}" ] && [ -n "${{ secrets.HARBOR_USERNAME }}" ] && [ -n "${{ secrets.HARBOR_PASSWORD }}" ]; then
            REGISTRY="${{ secrets.HARBOR_REGISTRY }}"
            PUSH_IMAGE=true
          else
            REGISTRY="eshelf"
            PUSH_IMAGE=false
            echo "Harbor credentials not configured, building only (no push)"
          fi
          docker build -t $REGISTRY/ml-service:$IMAGE_TAG backend/services/ml-service/
          docker tag $REGISTRY/ml-service:$IMAGE_TAG $REGISTRY/ml-service:latest
          if [ "$PUSH_IMAGE" = "true" ]; then
            docker push $REGISTRY/ml-service:$IMAGE_TAG
            docker push $REGISTRY/ml-service:latest
          else
            echo "Skipping push - Harbor credentials not configured"
          fi

  # Summary
  summary:
    needs: [changes, build-frontend, build-api-gateway, build-auth-service, build-book-service, build-user-service, build-ml-service]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Components:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: ${{ needs.changes.outputs.api-gateway }}" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.changes.outputs.auth-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- Book Service: ${{ needs.changes.outputs.book-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: ${{ needs.changes.outputs.user-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- ML Service: ${{ needs.changes.outputs.ml-service }}" >> $GITHUB_STEP_SUMMARY

