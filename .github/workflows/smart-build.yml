name: Smart Build Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - 'README.md'
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'presentation.tex'
      - 'CHECKLIST_YEU_CAU.md'
      - 'DEMO_GUIDE.md'
      - 'yeucaumonhoc.md'
      - 'gopygiangvien.md'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - '*.md'
      - 'docs/**'
      - '.gitignore'
      - 'presentation.tex'
      - 'CHECKLIST_YEU_CAU.md'
      - 'DEMO_GUIDE.md'
      - 'yeucaumonhoc.md'
      - 'gopygiangvien.md'

jobs:
  # Detect changes
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.code-check.outputs.frontend }}
      api-gateway: ${{ steps.code-check.outputs.api-gateway }}
      auth-service: ${{ steps.code-check.outputs.auth-service }}
      book-service: ${{ steps.code-check.outputs.book-service }}
      user-service: ${{ steps.code-check.outputs.user-service }}
      ml-service: ${{ steps.code-check.outputs.ml-service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Cần 2 commits để so sánh
      
      # Bước 1: Filter paths (nhanh hơn)
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'public/**'
              - 'index.html'
              - 'package.json'
              - 'vite.config.js'
            api-gateway:
              - 'backend/services/api-gateway/**'
            auth-service:
              - 'backend/services/auth-service/**'
            book-service:
              - 'backend/services/book-service/**'
            user-service:
              - 'backend/services/user-service/**'
            ml-service:
              - 'backend/services/ml-service/**'
      
      # Bước 2: Check xem có code changes thực sự không (bỏ qua comment)
      - name: Check for real code changes
        id: code-check
        run: |
          chmod +x scripts/check-service-changes.sh
          
          # Base ref để so sánh
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
          else
            BASE_REF="HEAD~1"
          fi
          
          # Check từng service
          check_service() {
            local service_paths="$1"
            local service_name="$2"
            
            if [ "${{ steps.filter.outputs.$service_name }}" = "true" ]; then
              if ./scripts/check-service-changes.sh $service_paths "$BASE_REF"; then
                echo "$service_name=true" >> $GITHUB_OUTPUT
                echo "✓ $service_name: Real code changes detected"
              else
                echo "$service_name=false" >> $GITHUB_OUTPUT
                echo "✗ $service_name: Only comment/whitespace changes, skipping build"
              fi
            else
              echo "$service_name=false" >> $GITHUB_OUTPUT
              echo "○ $service_name: No file changes"
            fi
          }
          
          check_service "src public index.html package.json vite.config.js" "frontend"
          check_service "backend/services/api-gateway" "api-gateway"
          check_service "backend/services/auth-service" "auth-service"
          check_service "backend/services/book-service" "book-service"
          check_service "backend/services/user-service" "user-service"
          check_service "backend/services/ml-service" "ml-service"

  # Build Frontend (only if changed)
  build-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        continue-on-error: false
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/

  # Build API Gateway (only if changed)
  build-api-gateway:
    needs: changes
    if: needs.changes.outputs.api-gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        working-directory: backend/services/api-gateway
        run: |
          docker build -t eshelf/api-gateway:${{ github.sha }} .
          docker tag eshelf/api-gateway:${{ github.sha }} eshelf/api-gateway:latest

  # Build Auth Service (only if changed)
  build-auth-service:
    needs: changes
    if: needs.changes.outputs.auth-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        working-directory: backend/services/auth-service
        run: |
          docker build -t eshelf/auth-service:${{ github.sha }} .
          docker tag eshelf/auth-service:${{ github.sha }} eshelf/auth-service:latest

  # Build Book Service (only if changed)
  build-book-service:
    needs: changes
    if: needs.changes.outputs.book-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        working-directory: backend/services/book-service
        run: |
          docker build -t eshelf/book-service:${{ github.sha }} .
          docker tag eshelf/book-service:${{ github.sha }} eshelf/book-service:latest

  # Build User Service (only if changed)
  build-user-service:
    needs: changes
    if: needs.changes.outputs.user-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        working-directory: backend/services/user-service
        run: |
          docker build -t eshelf/user-service:${{ github.sha }} .
          docker tag eshelf/user-service:${{ github.sha }} eshelf/user-service:latest
        continue-on-error: false

  # Build ML Service (only if changed)
  build-ml-service:
    needs: changes
    if: needs.changes.outputs.ml-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image
        working-directory: backend/services/ml-service
        run: |
          docker build -t eshelf/ml-service:${{ github.sha }} .
          docker tag eshelf/ml-service:${{ github.sha }} eshelf/ml-service:latest

  # Summary
  summary:
    needs: [changes, build-frontend, build-api-gateway, build-auth-service, build-book-service, build-user-service, build-ml-service]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Components:" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.changes.outputs.frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Gateway: ${{ needs.changes.outputs.api-gateway }}" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.changes.outputs.auth-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- Book Service: ${{ needs.changes.outputs.book-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: ${{ needs.changes.outputs.user-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- ML Service: ${{ needs.changes.outputs.ml-service }}" >> $GITHUB_STEP_SUMMARY

