services:
  # API Gateway
  api-gateway:
    build: ./services/api-gateway
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3000
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://auth-service:3001}
      - BOOK_SERVICE_URL=${BOOK_SERVICE_URL:-http://book-service:3002}
      - USER_SERVICE_URL=${USER_SERVICE_URL:-http://user-service:3003}
      - ML_SERVICE_URL=${ML_SERVICE_URL:-http://ml-service:8000}
      - JWT_SECRET=${JWT_SECRET:-your-secret-key}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000}
    depends_on:
      - auth-service
      - book-service
      - user-service
      - ml-service
    networks:
      - eshelf-network

  # Auth Service
  auth-service:
    build: ./services/auth-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3001
      - JWT_SECRET=${JWT_SECRET:-your-secret-key}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-your-refresh-secret}
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-eshelf}:${POSTGRES_PASSWORD:-eshelf123}@postgres:5432/${POSTGRES_DB:-eshelf}?schema=public}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000}
    depends_on:
      db-migration:
        condition: service_completed_successfully
    networks:
      - eshelf-network

  # Book Service
  book-service:
    build: ./services/book-service
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3002
      - JWT_SECRET=${JWT_SECRET:-your-secret-key}
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-eshelf}:${POSTGRES_PASSWORD:-eshelf123}@postgres:5432/${POSTGRES_DB:-eshelf}?schema=public}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000}
    volumes:
      - ../src/data:/app/data:ro
    depends_on:
      db-migration:
        condition: service_completed_successfully
    networks:
      - eshelf-network

  # User Service
  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3003
      - JWT_SECRET=${JWT_SECRET:-your-secret-key}
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-eshelf}:${POSTGRES_PASSWORD:-eshelf123}@postgres:5432/${POSTGRES_DB:-eshelf}?schema=public}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:3000}
    depends_on:
      db-migration:
        condition: service_completed_successfully
    networks:
      - eshelf-network

  # ML Service
  ml-service:
    build: ./services/ml-service
    ports:
      - "8000:8000"
    volumes:
      - ../src/data:/app/data:ro
    networks:
      - eshelf-network

  # Database Migration Service
  db-migration:
    build: ./database
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-eshelf}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-eshelf123}
      - POSTGRES_DB=${POSTGRES_DB:-eshelf}
      - DATABASE_URL=${DATABASE_URL:-postgresql://${POSTGRES_USER:-eshelf}:${POSTGRES_PASSWORD:-eshelf123}@postgres:5432/${POSTGRES_DB:-eshelf}?schema=public}
    volumes:
      - ../src/data:/app/data:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - eshelf-network
    restart: "no"

  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-eshelf}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-eshelf123}
      - POSTGRES_DB=${POSTGRES_DB:-eshelf}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - eshelf-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-eshelf} -d ${POSTGRES_DB:-eshelf}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - eshelf-network

networks:
  eshelf-network:
    driver: bridge

volumes:
  postgres_data: