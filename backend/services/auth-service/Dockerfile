# ==========================================
# 1. Build Stage
# ==========================================
FROM node:20-alpine AS builder

WORKDIR /app

# ğŸ‘‡ QUAN TRá»ŒNG: CÃ i OpenSSL Ä‘á»ƒ Prisma cháº¡y Ä‘Æ°á»£c
RUN apk add --no-cache openssl

# 1. Copy file Ä‘á»‹nh nghÄ©a
COPY package*.json ./

# 2. Copy folder prisma (Chá»©a schema.prisma)
# LÆ°u Ã½: Báº¡n nhá»› copy folder prisma tá»« database sang thÆ° má»¥c auth-service trÆ°á»›c nhÃ©!
COPY prisma ./prisma/

# 3. CÃ i Ä‘áº·t dependencies (Full Ä‘á»ƒ cÃ³ Prisma CLI)
RUN npm ci

# 4. Sinh code Prisma Client (Káº¿t ná»‘i DB)
RUN npx prisma generate

# ==========================================
# 2. Production Stage
# ==========================================
FROM node:20-alpine

WORKDIR /app

# ğŸ‘‡ QUAN TRá»ŒNG: CÃ i OpenSSL cho mÃ´i trÆ°á»ng cháº¡y tháº­t
RUN apk add --no-cache openssl

# Táº¡o user non-root báº£o máº­t
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# 5. Copy node_modules tá»« builder (Ä‘Ã£ chá»©a Prisma Client xá»‹n)
COPY --from=builder /app/node_modules ./node_modules

# 6. Copy source code
COPY src ./src
COPY package.json ./

# 7. Copy folder prisma sang Ä‘á»ƒ trÃ¡nh lá»—i khÃ´ng tÃ¬m tháº¥y schema lÃºc cháº¡y
COPY --from=builder /app/prisma ./prisma

USER nodejs

EXPOSE 3001

ENV NODE_ENV=production

CMD ["node", "src/app.js"]