# ==========================================
# 1. Build Stage
# ==========================================
FROM node:20-alpine AS builder

WORKDIR /app

# ðŸ‘‡ THÃŠM DÃ’NG NÃ€Y: CÃ i OpenSSL Ä‘á»ƒ Prisma Generate cháº¡y Ä‘Æ°á»£c
RUN apk add --no-cache openssl

# 1. Copy file Ä‘á»‹nh nghÄ©a
COPY package*.json ./

# 2. Copy prisma (Tá»« thÆ° má»¥c hiá»‡n táº¡i vÃ o trong Docker)
COPY prisma ./prisma/

# 3. CÃ i Ä‘áº·t Ä‘áº§y Ä‘á»§ Ä‘á»ƒ cÃ³ CLI
RUN npm ci

# 4. Táº¡o Prisma Client
RUN npx prisma generate

# ==========================================
# 2. Production Stage
# ==========================================
FROM node:20-alpine

WORKDIR /app

# ðŸ‘‡ THÃŠM DÃ’NG NÃ€Y: CÃ i OpenSSL Ä‘á»ƒ App cháº¡y Ä‘Æ°á»£c (Runtime)
RUN apk add --no-cache openssl

# Add non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# 5. Copy node_modules tá»« builder (Ä‘Ã£ chá»©a Prisma Client)
COPY --from=builder /app/node_modules ./node_modules

# 6. Copy source code
COPY src ./src
COPY package.json ./

# 7. Copy folder prisma tá»« builder sang (Ä‘á»ƒ trÃ¡nh lá»—i not found)
COPY --from=builder /app/prisma ./prisma

USER nodejs

EXPOSE 3002

ENV NODE_ENV=production

CMD ["node", "src/app.js"]